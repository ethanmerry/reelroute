<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="pageTitle"> ReelRoute</title>
    <script src="movietitle.js"></script>
    <script>
        sessionStorage.setItem('links', 0);
        var nowdate = new Date()
        sessionStorage.setItem('startTime', nowdate);
        fetch('files/startingMovie.json')
            .then(response => response.json())
            .then(data => {
                const idValue = data.id;
                sessionStorage.setItem('id', idValue);
            })
            .catch(error => {
                console.log('Error:', error);
            });

        sessionStorage.setItem('type', "movie");
        fetch('files/endMovie.json')
            .then(response => response.json())
            .then(data => {
                const idValue = data.id;
                sessionStorage.setItem('endID', idValue);
            })
            .catch(error => {
                console.log('Error:', error);
            });
    </script>
    <link rel="icon" type="image/x-icon" href="images/favicon.svg">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;900&family=Poppins:ital,wght@0,700;1,900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="play.css">
</head>
<body>
    <div id="overlay">
        <img draggable="false" class="errlogo" src="images/ReelRoute White.svg">
        <div class="textbox">
            <h2 class="info">Oops! Hold on tight!</h2>
            <p class="errsubtitle">Sadly, the Force wasn't on our side when it came to obtaining our movie reels. It seems that our connection to our movies have been disrupted, making it unable for you to play right now. You can try overcoming this disturbance by refreshing the page or ensuring a strong network connection.</p>
            <p class="errsubtitle">Whilst you're here, why not take a look at how to play ReelRoute, so when you get around to playing you are a master at the art of film navigation.</p>
        </div>    
    </div>
    <script>
        const options = {
          method: 'GET',
          headers: {
            accept: 'application/json',
            Authorization: 'Bearer eyJhbGciOiJIUzI1NiJ9.eyJhdWQiOiIzMzU5ZWVlODE4NzMwYTBmMDExYTA3YjdlNmU3MzM3NSIsInN1YiI6IjY0ODc1OTIxYzAzNDhiMDBhZWQ1Nzc3YiIsInNjb3BlcyI6WyJhcGlfcmVhZCJdLCJ2ZXJzaW9uIjoxfQ.qtny7zLA5JZuo2moI3UYBzi4grqAjwK5NMCyn85zO3U'
          }
        };
        
        fetch('https://api.themoviedb.org/3/authentication', options)
          .then(response => response.json())
          .then(response => document.getElementById("overlay").style.display = "block")
          .catch(err => document.getElementById("overlay").style.display = "block");
    </script>
    <div class="main">
        <div id="container" class="cast">
            <script>
                // Function to fetch movie details by movie ID
                async function fetchMovieDetails(movieId) {
                const apiKey = '3359eee818730a0f011a07b7e6e73375'; // Replace with your TMDB API key
                const url = `https://api.themoviedb.org/3/movie/${movieId}/credits?api_key=${apiKey}`;

                try {
                    const response = await fetch(url);
                    const data = await response.json();
                    return data.cast;
                } catch (error) {
                    console.log('Error fetching movie details:', error);
                    return [];
                }
                }
                
                // Function to fetch actor/crew details by person ID
                async function fetchPersonDetails(personId, creditType) {
                    const apiKey = '3359eee818730a0f011a07b7e6e73375'; // Replace with your TMDB API key
                    const url = `https://api.themoviedb.org/3/person/${personId}/${creditType}?api_key=${apiKey}`;

                try {
                    const response = await fetch(url);
                    const data = await response.json();
                    return data.cast;
                } catch (error) {
                    console.log('Error fetching person details:', error);
                    return [];
                }
                }
               
                // Function to create and append an image and text element to a parent element
                function createImageWithText(parentElement, imageUrl, text, entityid) {
                    const wrapperElement = document.createElement('div');
                    wrapperElement.className = 'item';

                    const imageElement = document.createElement('img');
                    imageElement.src = imageUrl;
                    imageElement.className = 'image';
                    imageElement.draggable = false
                    imageElement.addEventListener('contextmenu', (e) => {
                      e.preventDefault();
                    });
                    wrapperElement.appendChild(imageElement);
                    imageElement.addEventListener('click', () => {
                        sessionStorage.setItem('id',entityid);
                        let numlinks = sessionStorage.getItem('links');
                        let updatedValue = +numlinks + 1;
                        sessionStorage.setItem('links',updatedValue);
                        const currentType = sessionStorage.getItem('type');
                        if (currentType == 'movie') {
                            sessionStorage.setItem('type','cast');
                        } else {
                            sessionStorage.setItem('type','movie');
                        }
                        window.updatelinks();
                        window.updateposter();

                        const list = document.getElementById("container");
                        while (list.hasChildNodes()) {
                          list.removeChild(list.firstChild);
                        }                     
                        updatecredits()

                    });

                    const textElement = document.createElement('p');
                    textElement.textContent = text;
                    textElement.className = 'caption';
                    wrapperElement.appendChild(textElement);

                    parentElement.appendChild(wrapperElement);
                }

                // Function to handle the different types and fetch the required data
                async function fetchDataByType(type, id) {
                    if (type === 'movie') {
                        const movieCredits = await fetchMovieDetails(id);
                        const containerElement = document.getElementById('container');
                        movieCredits.forEach((cast) => {
                        if (cast.profile_path) {
                            const image = `https://image.tmdb.org/t/p/w200${cast.profile_path}`;
                            const name = cast.name;
                            const entityid = cast.id;
                            createImageWithText(containerElement, image, name, entityid);
                        }
                        });
                    } else if (type === 'cast') {
                        const creditType = type === 'director' ? 'movie_credits' : 'combined_credits';
                        const personCredits = await fetchPersonDetails(id, creditType);
                        const containerElement = document.getElementById('container');
                        personCredits.forEach((credit) => {
                        if (credit.media_type === 'movie' && credit.poster_path) {
                                const image = `https://image.tmdb.org/t/p/w200${credit.poster_path}`;
                                const name = credit.title;
                                const entityid = credit.id;
                                createImageWithText(containerElement, image, name, entityid);
                        }
                        });
                    } else {
                        console.log('Invalid type');
                    }
                    }

                window.updatecredits = function() {
                    // Check session storage for the "type" and "id" values
                    const type = sessionStorage.getItem('type');
                    const id = sessionStorage.getItem('id');
                    // Call the function to fetch and handle the data based on the type and id
                    fetchDataByType(type, id);
                };
                updatecredits();
            </script>
        </div>
    </div>
    <div class="sidebar">
        <img draggable="false" class="logo" src="images/ReelRoute White.svg">
        <img draggable="false" id="poster" class="poster" src="" alt="film poster">
        <script>
            function getPosterOrHeadshot(type, id) {
              const apiKey = "3359eee818730a0f011a07b7e6e73375"; // Replace with your TMDb API key
              const baseUrl = "https://api.themoviedb.org/3";
            
              if (type === "movie") {
                // Get movie details
                const movieUrl = `${baseUrl}/movie/${id}?api_key=${apiKey}`;
                return fetch(movieUrl)
                  .then(response => response.json())
                  .then(movieData => {
                    const posterPath = movieData.poster_path;
                    if (posterPath) {
                      const posterUrl = `https://image.tmdb.org/t/p/w500/${posterPath}`;
                      return posterUrl;
                    }
                    return null;
                  });
              } else if (type === "cast") {
                // Get cast details
                const castUrl = `${baseUrl}/person/${id}?api_key=${apiKey}`;
                return fetch(castUrl)
                  .then(response => response.json())
                  .then(castData => {
                    const profilePath = castData.profile_path;
                    if (profilePath) {
                      const posterUrl = `https://image.tmdb.org/t/p/w500/${profilePath}`;
                      return posterUrl;
                    }
                    return null;
                  });
              }
            
              return Promise.resolve(null);
            }
            
            window.updateposter = function() {
                const currentid = sessionStorage.getItem('id');
                const idtype = sessionStorage.getItem('type')
                getPosterOrHeadshot(idtype, currentid)
                  .then(posterUrl => {
                    const posterElement = document.getElementById("poster");
                    if (posterUrl) {
                      posterElement.src = posterUrl;
                    } else {
                      posterElement.alt = "Film poster not found.";
                    }
                  });
            };
            updateposter();
        </script>
        <div class="linktime">
            <div class="boxbg" onclick="returntostart()" style="cursor: pointer">
                <h3 class="returnstart">RETURN TO START</h3>
                <script>
                    function returntostart() {
                        console.log("return to start");
                        fetch('files/startingMovie.json')
                            .then(response => response.json())
                            .then(data => {
                                const idValue = data.id;
                                sessionStorage.setItem('id', idValue);
                            })
                            .catch(error => {
                                console.log('Error:', error);
                            });
                        sessionStorage.setItem('type','movie');
                        window.updateposter();
                        const list = document.getElementById("container");
                        while (list.hasChildNodes()) {
                          list.removeChild(list.firstChild);
                        }                     
                        window.updatecredits()
                    };
                </script>
            </div>
            <div class="boxbg">
                <h2 class="subtitle">TO</h2>
                <img draggable="false" id="tologo" class="tologo" src="">
                <script>
                    // Retrieve the movie ID from session storage
                    const movieID = sessionStorage.getItem('endID');
                    
                    const options = {
                      method: 'GET',
                      headers: {
                        accept: 'application/json',
                        Authorization: 'Bearer eyJhbGciOiJIUzI1NiJ9.eyJhdWQiOiIzMzU5ZWVlODE4NzMwYTBmMDExYTA3YjdlNmU3MzM3NSIsInN1YiI6IjY0ODc1OTIxYzAzNDhiMDBhZWQ1Nzc3YiIsInNjb3BlcyI6WyJhcGlfcmVhZCJdLCJ2ZXJzaW9uIjoxfQ.qtny7zLA5JZuo2moI3UYBzi4grqAjwK5NMCyn85zO3U'
                      }
                    };
                    fetch('https://api.themoviedb.org/3/movie/${movieID}/images?language=en', options)
                      .then(response => response.json())
                      .then(response => {
                        const logoPath = response.logos[0].file_path;

                        // Construct the full URL for the movie logo
                        const logoURL = `https://image.tmdb.org/t/p/original${logoPath}`;
                    
                        // Use the logoURL as needed (e.g., display it in an <img> element)
                        const logoElement = document.getElementById("tologo");
                        if (logoURL) {
                          logoElement.src = logoURL;
                        } else {
                          logoElement.alt = "Film logo not found.";
                        }
                      })
                      .catch(error => {
                        console.error('Error:', error);
                      });

                </script>
            </div>
            <div class="boxbg">
                <h2 class="subtitle">LINKS</h2>
                <h3 id="linksnum" class="info">0</h3>
                <script>
                    window.updatelinks = function() {
                        var links = sessionStorage.getItem('links');
                        document.getElementById('linksnum').textContent = links;
                    }
                </script>
            </div>
            <div class="boxbg">
                <h2 class="subtitle">TIME</h2>
                <h3 id="time" class="info">00:00</h3>
                <script>
                    // Get the element to display the timer
                    const timerElement = document.getElementById('time');

                    // Set the start time
                    let startTime = new Date().getTime();

                    // Update the timer every second
                    setInterval(updateTimer, 1000);

                    function updateTimer() {
                        // Get the current time
                        let currentTime = new Date().getTime();

                        // Calculate the elapsed time in milliseconds
                        let elapsedTime = currentTime - startTime;

                        // Calculate minutes and seconds
                        let minutes = Math.floor(elapsedTime / 60000);
                        let seconds = Math.floor((elapsedTime % 60000) / 1000);

                        // Format the minutes and seconds as "00" if they are single-digit
                        let formattedMinutes = minutes < 10 ? '0' + minutes : minutes;
                        let formattedSeconds = seconds < 10 ? '0' + seconds : seconds;

                        // Update the timer element with the formatted time
                        timerElement.textContent = formattedMinutes + ':' + formattedSeconds;
                    }
                </script>
            </div>
        </div>
        <a href="howtoplay.html" target=”_blank” attribute> <img draggable="false" class="howto" src="images/icons/How to Play.svg"> </a>
   </div>
    
</body>
</html>
